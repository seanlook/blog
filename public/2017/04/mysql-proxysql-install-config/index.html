<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>ProxySQL之安装及配置详解 | Sean&#39;s Note</title>
<meta name="keywords" content="mysql, 中间件, proxysql">
<meta name="description" content="ProxySQL是一个高性能的MySQL中间件，拥有强大的规则引擎。具有以下特性：

连接池，而且是 multiplexing
主机和用户的最大连接数限制
自动下线后端DB

延迟超过阀值
ping 延迟超过阀值
网络不通或宕机


强大的规则路由引擎
实现读写分离
查询重写
sql流量镜像
支持prepared statement
支持Query Cache
支持负载均衡，与gelera结合自动failover

集这么多优秀特性于一身，那么缺点呢就是项目不够成熟，好在作者一直在及时更新，并且受到 Percona 官方的支持。">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/2017/04/mysql-proxysql-install-config/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8a19d6c7d40c68078a482516c7c2a326ccb9f6e9282cabe7240ecc1a80c6cb47.css" integrity="sha256-ihnWx9QMaAeKSCUWx8KjJsy59ukoLKvnJA7MGoDGy0c=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/img/logo.gif">
<link rel="apple-touch-icon" href="http://localhost:1313/logo.gif">
<link rel="mask-icon" href="http://localhost:1313/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/2017/04/mysql-proxysql-install-config/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Sean&#39;s Note (Alt + H)">Sean&#39;s Note</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      ProxySQL之安装及配置详解
    </h1>
    <div class="post-meta"><span title='2017-04-10 21:32:49 +0000 UTC'>2017-04-10</span>&nbsp;·&nbsp;13 min

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e5%ae%89%e8%a3%85" aria-label="1. 安装">1. 安装</a><ul>
                            
                    <li>
                        <a href="#%e7%bc%96%e8%af%91%e5%ae%89%e8%a3%85" aria-label="编译安装">编译安装</a></li></ul>
                    </li>
                    <li>
                        <a href="#2-%e5%86%85%e7%bd%ae%e5%ba%93%e8%a1%a8%e4%bb%8b%e7%bb%8d" aria-label="2. 内置库表介绍">2. 内置库表介绍</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#21-%e5%86%85%e7%bd%ae%e5%ba%93" aria-label="2.1 内置“库”">2.1 内置“库”</a></li>
                    <li>
                        <a href="#22-%e8%a1%a8-mysql_servers" aria-label="2.2 表 mysql_servers">2.2 表 <code>mysql_servers</code></a></li>
                    <li>
                        <a href="#23-%e8%a1%a8-mysql_users" aria-label="2.3 表 mysql_users">2.3 表 <code>mysql_users</code></a></li>
                    <li>
                        <a href="#24-%e8%a1%a8-mysql_replication_hostgroups" aria-label="2.4 表 mysql_replication_hostgroups">2.4 表 <code>mysql_replication_hostgroups</code></a></li>
                    <li>
                        <a href="#25-%e8%a1%a8-mysql_query_rules" aria-label="2.5 表 mysql_query_rules">2.5 表 <code>mysql_query_rules</code></a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#3-proxysql%e7%9a%84%e5%a4%9a%e5%b1%82%e9%85%8d%e7%bd%ae%e8%ae%be%e8%ae%a1" aria-label="3. proxysql的多层配置设计">3. proxysql的多层配置设计</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="参考：">参考：</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><p>ProxySQL是一个高性能的MySQL中间件，拥有强大的规则引擎。具有以下特性：</p>
<ul>
<li>连接池，而且是 <a href="http://xgknight.com/2017/04/17/mysql-proxysql-multiplexing/">multiplexing</a></li>
<li>主机和用户的最大连接数限制</li>
<li>自动下线后端DB
<ul>
<li>延迟超过阀值</li>
<li>ping 延迟超过阀值</li>
<li>网络不通或宕机</li>
</ul>
</li>
<li>强大的规则路由引擎</li>
<li>实现读写分离</li>
<li>查询重写</li>
<li>sql流量镜像</li>
<li>支持prepared statement</li>
<li>支持Query Cache</li>
<li>支持负载均衡，与gelera结合自动failover</li>
</ul>
<p>集这么多优秀特性于一身，那么缺点呢就是项目不够成熟，好在作者一直在及时更新，并且受到 Percona 官方的支持。</p>
<h1 id="1-安装">1. 安装<a hidden class="anchor" aria-hidden="true" href="#1-安装">#</a></h1>
<p>从 <a href="https://github.com/sysown/proxysql/releases">https://github.com/sysown/proxysql/releases</a> 下载相应的版本。这里我选择 <code>proxysql-1.3.5-1-centos67.x86_64.rpm</code>，也是当前最新稳定版。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">yum localinstall proxysql-1.3.5-1-centos67.x86_64.rpm -y
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以马上启动了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/etc/init.d/proxysql start
</span></span><span class="line"><span class="cl">Starting ProxySQL: DONE!
</span></span></code></pre></td></tr></table>
</div>
</div><p>proxysql有个配置文件 <code>/etc/proxysql.cnf</code>，只在第一次启动的时候有用，后续所有的配置修改都是对SQLite数据库操作，并且不会更新到proxysql.cnf文件中。ProxySQL绝大部分配置都可以在线修改，配置存储在  <code>/var/lib/proxysql/proxysql.db</code> 中，后面会介绍它的在线配置的设计方式。</p>
<p>proxysql 启动后会像 mysqld 一样，马上fork一个子进程，真正处理请求，而父进程负责监控子进程运行状况，如果crash了就拉起来。</p>
<h2 id="编译安装">编译安装<a hidden class="anchor" aria-hidden="true" href="#编译安装">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">安装高版本</span> <span class="n">gcc</span><span class="o">-</span><span class="mf">4.8</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cd /etc/yum.repos.d</span>
</span></span><span class="line"><span class="cl"><span class="c1"># wget https://copr.fedoraproject.org/coprs/rhscl/devtoolset-3/repo/epel-6/rhscl-devtoolset-3-epel-6.repo  \</span>
</span></span><span class="line"><span class="cl">  <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rhscl</span><span class="o">-</span><span class="n">devtoolset</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">epel</span><span class="o">-</span><span class="mf">6.</span><span class="n">repo</span>
</span></span><span class="line"><span class="cl"><span class="c1"># yum install -y  scl-utils policycoreutils-python</span>
</span></span><span class="line"><span class="cl"><span class="c1"># yum --disablerepo=&#39;*&#39; --enablerepo=&#39;rhscl-devtoolset-3&#39; install devtoolset-3-gcc devtoolset-3-gcc-c++ devtoolset-3-binutils</span>
</span></span><span class="line"><span class="cl"><span class="c1"># yum --enablerepo=testing-devtools-2-centos-6 install devtoolset-3-gcc devtoolset-3-gcc-c++ devtoolset-3-binutils</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">上一步会把</span> <span class="n">GCC</span> <span class="err">安装到以下目录</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rh</span><span class="o">/</span><span class="n">devtoolset</span><span class="o">-</span><span class="mi">3</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">接下来需要修改系统的配置，使默认的</span> <span class="n">gcc</span> <span class="err">和</span> <span class="n">g</span><span class="o">++</span> <span class="err">命令使用的是新安装的版本。启用</span><span class="n">SCL环境中新版本GCC</span><span class="err">：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># scl enable devtoolset-3 bash</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="err">现在查看</span> <span class="n">g</span><span class="o">++</span> <span class="err">的版本号：</span>
</span></span><span class="line"><span class="cl"><span class="c1"># gcc --version</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">编译安装</span><span class="n">proxysql</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cd proxysql-master</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make install</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="2-内置库表介绍">2. 内置库表介绍<a hidden class="anchor" aria-hidden="true" href="#2-内置库表介绍">#</a></h1>
<h3 id="21-内置库">2.1 内置“库”<a hidden class="anchor" aria-hidden="true" href="#21-内置库">#</a></h3>
<p>首先登陆到 proxysql 之后才能进一步配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">$</span> <span class="k">export</span> <span class="n">MYSQL_PS1</span><span class="o">=</span><span class="s2">&#34;(\u@\h:\p) [\d]&gt; &#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">uadmin</span> <span class="o">-</span><span class="n">padmin</span> <span class="o">-</span><span class="n">h127</span><span class="o">.</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">1</span> <span class="o">-</span><span class="n">P6032</span>
</span></span><span class="line"><span class="cl"><span class="n">Welcome</span> <span class="n">to</span> <span class="n">the</span> <span class="n">MySQL</span> <span class="n">monitor</span><span class="o">.</span>  <span class="n">Commands</span> <span class="n">end</span> <span class="n">with</span> <span class="p">;</span> <span class="ow">or</span> \<span class="n">g</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Your</span> <span class="n">MySQL</span> <span class="n">connection</span> <span class="n">id</span> <span class="n">is</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Server</span> <span class="n">version</span><span class="p">:</span> <span class="mf">5.6</span><span class="o">.</span><span class="mi">30</span> <span class="p">(</span><span class="n">ProxySQL</span> <span class="n">Admin</span> <span class="n">Module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+---------+-------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">seq</span> <span class="o">|</span> <span class="n">name</span>    <span class="o">|</span> <span class="n">file</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+---------+-------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">0</span>   <span class="o">|</span> <span class="n">main</span>    <span class="o">|</span>                               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">2</span>   <span class="o">|</span> <span class="n">disk</span>    <span class="o">|</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">proxysql</span><span class="o">/</span><span class="n">proxysql</span><span class="o">.</span><span class="n">db</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">3</span>   <span class="o">|</span> <span class="n">stats</span>   <span class="o">|</span>                               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">4</span>   <span class="o">|</span> <span class="n">monitor</span> <span class="o">|</span>                               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+---------+-------------------------------+</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>默认管理端口是6032，客户端服务端口是6033。默认的用户名密码都是 <code>admin</code>。</p>
<ul>
<li><code>main</code> 是默认的&quot;数据库&quot;名，表里存放后端db实例、用户验证、路由规则等信息。表名以 <code>runtime_</code>开头的表示proxysql当前运行的配置内容，不能通过dml语句修改，只能修改对应的不以 runtime_ 开头的（在内存）里的表，然后 <code>LOAD</code> 使其生效， <code>SAVE</code> 使其存到硬盘以供下次重启加载。</li>
<li><code>disk</code> 是持久化到硬盘的配置，sqlite数据文件。</li>
<li><code>stats</code> 是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询种类汇总/执行时间，等等。</li>
<li><code>monitor</code> 库存储 monitor 模块收集的信息，主要是对后端db的健康/延迟检查。</li>
</ul>
<p><code>global_variables</code> 有80多个变量可以设置，其中就包括监听的端口、管理账号、禁用monitor等，详细可参考 <a href="https://github.com/sysown/proxysql/wiki/Global-variables">https://github.com/sysown/proxysql/wiki/Global-variables</a> 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">tables</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">tables</span>                               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">global_variables</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_collations</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_query_rules</span>                    <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_replication_hostgroups</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_servers</span>                        <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_users</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_global_variables</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_query_rules</span>            <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_replication_hostgroups</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_servers</span>                <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_users</span>                  <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_scheduler</span>                    <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">scheduler</span>                            <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">admin</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6032</span><span class="p">)</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">tables</span> <span class="n">from</span> <span class="n">stats</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">tables</span>                         <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">global_variables</span>               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">stats_mysql_commands_counters</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">stats_mysql_connection_pool</span>    <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">stats_mysql_global</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">stats_mysql_processlist</span>        <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">stats_mysql_query_digest</span>       <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">stats_mysql_query_digest_reset</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">stats_mysql_query_rules</span>        <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">8</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-表-mysql_servers">2.2 表 <code>mysql_servers</code><a hidden class="anchor" aria-hidden="true" href="#22-表-mysql_servers">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; show create table mysql_servers\G
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">       table: mysql_servers
</span></span><span class="line"><span class="cl">Create Table: CREATE TABLE mysql_servers (
</span></span><span class="line"><span class="cl">    hostgroup_id INT NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT NOT NULL DEFAULT 3306,
</span></span><span class="line"><span class="cl">    status VARCHAR CHECK (UPPER(status) IN (&#39;ONLINE&#39;,&#39;SHUNNED&#39;,&#39;OFFLINE_SOFT&#39;, &#39;OFFLINE_HARD&#39;)) NOT NULL DEFAULT &#39;ONLINE&#39;,
</span></span><span class="line"><span class="cl">    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    compression INT CHECK (compression &gt;=0 AND compression &lt;= 102400) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 1000,
</span></span><span class="line"><span class="cl">    max_replication_lag INT CHECK (max_replication_lag &gt;= 0 AND max_replication_lag &lt;= 126144000) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    use_ssl INT CHECK (use_ssl IN(0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    max_latency_ms INT UNSIGNED CHECK (max_latency_ms&gt;=0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostgroup_id, hostname, port) )
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select * from mysql_servers;
</span></span><span class="line"><span class="cl">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+
</span></span><span class="line"><span class="cl">| hostgroup_id | hostname     | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment       |
</span></span><span class="line"><span class="cl">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+
</span></span><span class="line"><span class="cl">| 100          | 10.0.100.100 | 3307 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | db0,ReadWrite |
</span></span><span class="line"><span class="cl">| 1000         | 10.0.100.100 | 3307 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | db0,ReadWrite |
</span></span><span class="line"><span class="cl">| 1000         | 192.168.10.4 | 3316 | ONLINE | 4      | 0           | 1000            | 0                   | 0       | 0              | db0,ReadOnly  |
</span></span><span class="line"><span class="cl">| 101          | 10.0.100.101 | 3307 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | db1,ReadWrite |
</span></span><span class="line"><span class="cl">| 1001         | 192.168.10.4 | 3326 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | db1,ReadOnly  |
</span></span><span class="line"><span class="cl">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>hostgroup_id</code>: ProxySQL通过 hostgroup (下称HG) 的形式组织后端db实例。一个 HG 代表同属于一个角色
<ul>
<li>该表的主键是 <code>(hostgroup_id, hostname, port)</code>，可以看到一个 hostname:port 可以在多个hostgroup里面，如上面的 10.0.100.100:3307，这样可以避免 HG 1000 的从库全都不可用时，依然可以把读请求发到主库上。</li>
<li>一个 HG 可以有多个实例，即多个从库，可以通过 <code>weight</code> 分配权重</li>
<li>hostgroup_id 0 是一个特殊的HG，路由查询的时候，没有匹配到规则则默认选择 HG 0</li>
</ul>
</li>
<li><code>status</code>:
<ul>
<li><code>ONLINE</code>: 当前后端实例状态正常</li>
<li><code>SHUNNED</code>: 临时被剔除，可能因为后端 too many connections error，或者超过了可容忍延迟阀值 <code>max_replication_lag</code></li>
<li><code>OFFLINE_SOFT</code>: &ldquo;软离线&quot;状态，不再接受新的连接，但已建立的连接会等待活跃事务完成。</li>
<li><code>OFFLINE_HARD</code>: &ldquo;硬离线&quot;状态，不再接受新的连接，已建立的连接或被强制中断。当后端实例宕机或网络不可达，会出现。</li>
</ul>
</li>
<li><code>max_connections</code>: 允许连接到该后端实例的最大连接数。不要大于MySQL设置的 max_connections
如果后端实例 hostname:port 在多个 hostgroup 里，以较大者为准，而不是各自独立允许的最大连接数。</li>
<li><code>max_replication_lag</code>: 允许的最大延迟，主库不受这个影响，默认0。如果 &gt; 0， monitor 模块监控主从延迟大于阀值时，会临时把它变为 SHUNNED 。</li>
<li><code>max_latency_ms</code>: mysql_ping 响应时间，大于这个阀值会把它从连接池剔除（即使是ONLINE）</li>
<li><code>comment</code>: 备注，不建议留空。这有什么好讲呢，但是你可以通过它的内容如json格式的数据，配合自己写的check脚本，完成一些自动化的工作。</li>
</ul>
<p><code>compression</code> 和 <code>use_ssl</code> 顾名思义。</p>
<h3 id="23-表-mysql_users">2.3 表 <code>mysql_users</code><a hidden class="anchor" aria-hidden="true" href="#23-表-mysql_users">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; show create table mysql_users\G
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">       table: mysql_users
</span></span><span class="line"><span class="cl">Create Table: CREATE TABLE mysql_users (
</span></span><span class="line"><span class="cl">    username VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    password VARCHAR,
</span></span><span class="line"><span class="cl">    active INT CHECK (active IN (0,1)) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    use_ssl INT CHECK (use_ssl IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    default_hostgroup INT NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    default_schema VARCHAR,
</span></span><span class="line"><span class="cl">    schema_locked INT CHECK (schema_locked IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    transaction_persistent INT CHECK (transaction_persistent IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    fast_forward INT CHECK (fast_forward IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    backend INT CHECK (backend IN (0,1)) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    frontend INT CHECK (frontend IN (0,1)) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 10000,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (username, backend),
</span></span><span class="line"><span class="cl">    UNIQUE (username, frontend))
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select * from mysql_users;
</span></span><span class="line"><span class="cl">+----------+-----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+
</span></span><span class="line"><span class="cl">| username | password  | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |
</span></span><span class="line"><span class="cl">+----------+-----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+
</span></span><span class="line"><span class="cl">| user0    | password0 | 1      | 0       | 0                 | NULL           | 0             | 1                      | 0            | 1       | 1        | 10000           |
</span></span><span class="line"><span class="cl">| read1    | password1 | 1      | 0       | 0                 | NULL           | 0             | 1                      | 0            | 1       | 1        | 10000           |
</span></span><span class="line"><span class="cl">+----------+-----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+
</span></span><span class="line"><span class="cl">2 rows in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select username,password,transaction_persistent,active,backend,frontend,max_connections from runtime_mysql_users;
</span></span><span class="line"><span class="cl">+----------+------------------------------+------------------------+--------+---------+----------+-----------------+
</span></span><span class="line"><span class="cl">| username | password                     | transaction_persistent | active | backend | frontend | max_connections |
</span></span><span class="line"><span class="cl">+----------+------------------------------+------------------------+--------+---------+----------+-----------------+
</span></span><span class="line"><span class="cl">| user0    | *FAB0955B2CE7AE2DAFEE46C3... | 1                      | 1      | 0       | 1        | 10000           |
</span></span><span class="line"><span class="cl">| read1    | *88A287979B45658C6CE41FB9... | 1                      | 1      | 0       | 1        | 10000           |
</span></span><span class="line"><span class="cl">| user0    | *FAB0955B2CE7AE2DAFEE46C3... | 1                      | 1      | 1       | 0        | 10000           |
</span></span><span class="line"><span class="cl">| read1    | *88A287979B45658C6CE41FB9... | 1                      | 1      | 1       | 0        | 10000           |
</span></span><span class="line"><span class="cl">+----------+------------------------------+------------------------+--------+---------+----------+-----------------+
</span></span><span class="line"><span class="cl">4 rows in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>username</code>, <code>password</code>: 连接后端db的用户密码。
这个密码你可以插入明文，也可以插入hash加密后的密文，proxysql会检查你插入的时候密码是否以  <code>*</code> 开头来判断，而且密文要在其它地方使用 <code>PASSWORD()</code>生成。
但到 <em>runtime_mysql_users</em> 里，都统一变成了密文，所以可以明文插入，再 <code>SAVE MYSQL USERS TO MEM</code>，此时看到的也是HASH密文。</li>
<li><code>active</code>: 是否生效该用户。</li>
<li><code>default_hostgroup</code>: 这个用户的请求没有匹配到规则时，默认发到这个 hostgroup，默认0</li>
<li><code>default_schema</code>: 这个用户连接时没有指定 database name 时，默认使用的schema
注意表面上看默认为NULL，但实际上受到变量 <code>mysql-default_schema</code> 的影响，默认为 information_schema。关于这个参考我所提的 issue <a href="https://github.com/sysown/proxysql/issues/988#issuecomment-293876759">#988</a></li>
<li><code>transaction_persistent</code>: 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不伦是否会匹配上其它路由规则，直到事务结束。
虽然默认是0，但我建议还是设成1，虽然一般来说由于前段应用的空值，为0出问题的情况几乎很小。作者也在考虑默认设成 1，<a href="https://github.com/sysown/proxysql/issues/793">refer this issue #793</a></li>
<li><code>frontend</code>, <code>backend</code>: 目前版本这两个都需要使用默认的1，将来有可能会把 * Client -&gt; ProxySQL * (frontend) 与 * ProxySQL -&gt; BackendDB * (backend)的认证分开。
从 <em>runtime_mysql_users</em> 表内容看到，记录数比 <em>mysql_users</em> 多了一倍，就是把前端认证与后端认证独立出来的结果。</li>
<li><code>fast_forward</code>: 忽略查询重写/缓存层，直接把这个用户的请求透传到后端DB。相当于只用它的连接池功能，一般不用，路由规则 <code>.*</code> 就行了。</li>
</ul>
<h3 id="24-表-mysql_replication_hostgroups">2.4 表 <code>mysql_replication_hostgroups</code><a hidden class="anchor" aria-hidden="true" href="#24-表-mysql_replication_hostgroups">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CREATE TABLE mysql_replication_hostgroups (
</span></span><span class="line"><span class="cl">    writer_hostgroup INT CHECK (writer_hostgroup&gt;=0) NOT NULL PRIMARY KEY,
</span></span><span class="line"><span class="cl">    reader_hostgroup INT NOT NULL CHECK (reader_hostgroup&lt;&gt;writer_hostgroup AND reader_hostgroup&gt;0),
</span></span><span class="line"><span class="cl">    comment VARCHAR,
</span></span><span class="line"><span class="cl">    UNIQUE (reader_hostgroup))
</span></span></code></pre></td></tr></table>
</div>
</div><p>定义 hostgroup 的主从关系。ProxySQL monitor 模块会监控 HG 后端所有servers 的 <code>read_only</code> 变量，如果发现从库的 read_only 变为0、主库变为1，则认为角色互换了，自动改写 mysql_servers 表里面 hostgroup 关系，达到自动 Failover 效果。</p>
<p>目前这个表我是留空的，它与Gelera或PXC结合起来用比较合适。</p>
<h3 id="25-表-mysql_query_rules">2.5 表 <code>mysql_query_rules</code><a hidden class="anchor" aria-hidden="true" href="#25-表-mysql_query_rules">#</a></h3>
<p>ProxySQL非常核心一个表，定义查询路由规则，参考 <a href="https://github.com/sysown/proxysql/wiki/MySQL-Query-Rules">https://github.com/sysown/proxysql/wiki/MySQL-Query-Rules</a> ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; show create table mysql_query_rules\G
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">       table: mysql_query_rules
</span></span><span class="line"><span class="cl">Create Table: CREATE TABLE mysql_query_rules (
</span></span><span class="line"><span class="cl">    rule_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
</span></span><span class="line"><span class="cl">    active INT CHECK (active IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    username VARCHAR,
</span></span><span class="line"><span class="cl">    schemaname VARCHAR,
</span></span><span class="line"><span class="cl">    flagIN INT NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    client_addr VARCHAR,
</span></span><span class="line"><span class="cl">    proxy_addr VARCHAR,
</span></span><span class="line"><span class="cl">    proxy_port INT,
</span></span><span class="line"><span class="cl">    digest VARCHAR,
</span></span><span class="line"><span class="cl">    match_digest VARCHAR,
</span></span><span class="line"><span class="cl">    match_pattern VARCHAR,
</span></span><span class="line"><span class="cl">    negate_match_pattern INT CHECK (negate_match_pattern IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    flagOUT INT,
</span></span><span class="line"><span class="cl">    replace_pattern VARCHAR,
</span></span><span class="line"><span class="cl">    destination_hostgroup INT DEFAULT NULL,
</span></span><span class="line"><span class="cl">    cache_ttl INT CHECK(cache_ttl &gt; 0),
</span></span><span class="line"><span class="cl">    reconnect INT CHECK (reconnect IN (0,1)) DEFAULT NULL,
</span></span><span class="line"><span class="cl">    timeout INT UNSIGNED,
</span></span><span class="line"><span class="cl">    retries INT CHECK (retries&gt;=0 AND retries &lt;=1000),
</span></span><span class="line"><span class="cl">    delay INT UNSIGNED,
</span></span><span class="line"><span class="cl">    mirror_flagOUT INT UNSIGNED,
</span></span><span class="line"><span class="cl">    mirror_hostgroup INT UNSIGNED,
</span></span><span class="line"><span class="cl">    error_msg VARCHAR,
</span></span><span class="line"><span class="cl">    log INT CHECK (log IN (0,1)),
</span></span><span class="line"><span class="cl">    apply INT CHECK(apply IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    comment VARCHAR)
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>rule_id</code>: 表主键，自增。规则处理是以 rule_id 的顺序进行。</li>
<li><code>active</code>: 只有 active=1 的规则才会参与匹配。</li>
<li><code>username</code>: 如果非 NULL，只有连接用户是 username 的值才会匹配</li>
<li><code>schemaname</code>: 如果非 NULL，只有查询连接使用的db是 schemaname 的值才会匹配。
注意如果是 NULL，不代表连接没有使用schema，而是不伦任何schema都进一步匹配。</li>
<li><code>flagIN</code>, <code>flagOUT</code>, <code>apply</code>: 用来定义路由链 chains of rules
<ul>
<li>首先会检查 flagIN=0 的规则，以rule_id的顺序；如果都没匹配上，则走这个用户的 default_hostgroup</li>
<li>当匹配一条规则后，会检查 <code>flagOUT</code>
<ul>
<li>如果不为NULL，并且 flagIN != flagOUT ，则进入以flagIN为上一个flagOUT值的新规则链</li>
<li>如果不为NULL，并且 flagIN = flagOUT，则应用这条规则</li>
<li>如果为NULL，或者 apply=1，则结束，应用这条规则</li>
<li>如果最终没有匹配到，则找到这个用户的 default_hostgroup
<img alt="proxysql route chain" loading="lazy" src="http://github.com/seanlook/sean-notes-comment/raw/main/static/proxysql-route-rule-flag.png"></li>
</ul>
</li>
</ul>
</li>
<li><code>client_addr</code>: 匹配客户端来源IP</li>
<li><code>proxy_addr</code>, <code>proxy_port</code>: 匹配本地proxysql的IP、端口。我目前没有想到它的应用场景，可能是把proxysql监听在多个接口上，分发到不同的业务？</li>
<li><code>digest</code>: 精确的匹配一类查询。</li>
<li><code>match_digest</code>: 正则匹配一类查询。query digest 是指对查询去掉具体值后进行“模糊化”后的查询，类似 <em>pt-fingerprint</em> / <em>pt-query-digest</em> 的效果。</li>
<li><code>match_pattern</code>: 正则匹配查询。
以上都是匹配查询的规则，目前1.3.5使用的正则引擎只有 RE2 ，1.4版本可以通过变量 <a href="https://github.com/sysown/proxysql/wiki/Global-variables#mysql-query_processor_regex"><code>mysql-query_processor_regex</code></a> 设置 RE2 或者 PCRE，且1.4开始默认是PCRE。
ProxySQL的作者 renecannao 自己推荐用 match_digest 。关于每条查询都会计算digest对性能的影响，我提出疑问后，作者在这篇文章<a href="https://www.percona.com/blog/2017/04/10/proxysql-rules-do-i-have-too-many/#comment-10967989">ProxySQL Rules: Do I Have Too Many?</a>的评论里做出了解释。大意是说计算query digest确实会有性能损失，但是确实proxysql里面非常重要特性，主要是两点：
<ol>
<li>proxysql无法知道连接复用(multipexing)是否必须被自动禁用，比如连接里面有variables/tmp tables/lock table等特殊命令，是不能复用的。</li>
<li>完整的查询去匹配正则的效率，一般没有参数化后的查询匹配效率高，因为有很长的字符串内容需要处理。再者，<code>SELECT * FROM randomtable WHERE comment LIKE ‘%INTO sbtest1 % FROM sbtest2 %’</code>字符串里有类似这样的语句，很难排除误匹配。</li>
</ol>
</li>
<li><code>negate_match_pattern</code>: 反向匹配，相当于对 match_digest/match_pattern 的匹配取反。</li>
<li><code>re_modifiers</code>: 修改正则匹配的参数，比如默认的：忽略大小写<code>CASELESS</code>、禁用<code>GLOBAL</code></li>
</ul>
<p>上面都是匹配规则，下面是匹配后的行为：</p>
<ul>
<li><code>replace_pattern</code>: 查询重写，默认为空，不rewrite。
rewrite规则要遵守  <a href="https://github.com/google/re2/wiki/Syntax">RE2::Replace</a> 。</li>
<li><code>destination_hostgroup</code>: 路由查询到这个 hostgroup。当然如果用户显式 start transaction 且 transaction_persistent=1，那么即使匹配到了，也依然按照事务里第一条sql的路由规则去走。</li>
<li><code>cache_ttl</code>: 查询结果缓存的毫秒数。
proxysql这个 Query Cache 与 MySQL 自带的query cache不是同一个。proxysql query cache也不会关心后端数据是否被修改，它所做的就是针对某些特定种类的查询结果进行缓存，比如一些历史数据的count结果。一般不设。</li>
<li><code>timeout</code>: 这一类查询执行的最大时间（毫秒），超时则自动kill。
这是对后端DB的保护机制，相当于阿里云RDS <code>loose_max_statement_time</code> 变量的功能，但是注意不同的是，阿里云这个变量的时间时不包括DML操作出现InnoDB行锁等待的时间，而ProxySQL的这个 timeout 是计算从发送sql到等待响应的时间。默认<code>mysql-default_query_timeout</code>给的是 10h .</li>
<li><code>retries</code>: 语句在执行时失败时，重试次数。默认由 <code>mysql-query_retries_on_failure</code>变量指定，为1 。
我个人建议把它设成0，即不重试。因为执行失败，对select而言很少见，主要是dml，但自己重试对数据不放心。</li>
<li><code>delay</code>: 查询延迟执行，这是ProxySQL提供的限流机制，会让其它的查询优先执行。
默认值 <code>mysql-default_query_delay</code>，为0。我们一般不用，其实还是要配合应用端使用，比如这边延迟执行，但上层等待你返回，那前端不就堵住了，没准出现雪崩效应。</li>
<li><code>mirror_flagOUT</code>,<code>mirror_hostgroup</code>
这两个高级了，目前这部分文档不全，功能是SQL镜像。顾名思义，就是把匹配到的SQL除了发送到 destination_hostgroup，同时镜像一份到这里的hostgroup，比如我们的测试库。比如这种场景，数据库要从5.6升级到5.7，要验证现有查询语句对5.7的适用情况，就可以把生产流量镜像到5.7新库上验证。</li>
<li><code>error_msg</code>: 默认为NULL，如果指定了则这个查询直接被 block 掉，马上返回这个错误信息。
这个功能也很实用，比如线上突然冒出一个 “坏查询”，应用端不方便马上发版解决，我们就可以在这配置一个规则，把查询屏蔽掉，想正常的mysql报错那样抛异常。下一篇文章有演示。</li>
<li><code>multiplex</code>: 连接是否复用。
关于这个，单独起一篇文章来写，传送门：http://xgknight.com/2017/04/17/mysql-proxysql-multiplexing/</li>
<li><code>log</code>: 是否记录查询日志。可以看到log是否记录的对象是根据规则。
要开启日志记录，需要设置变量 <code>mysql-eventslog_filename</code> 来指定文件名，然后这个 log 标记为1。但是目前proxysql记录的日志是二进制格式，需要特定的工具才能读取： eventslog_reader_sample 。这个工具在源码目录 tools下面，我下载的1.3.5版本rpm表竟然还没有编译它。
参考 issue <a href="https://github.com/sysown/proxysql/issues/561">#561 Logging all queries</a></li>
</ul>
<p>照 <a href="https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system#modifying-config-at-runtime">wiki Multi-layer-configuration-system</a> 所说，在debug版本里应该有个 debug_levels 表来定义日志级别，但我没找到。据作者回复，上面的方式已过时，推荐 <code>mysql-eventslog_filename</code>。</p>
<h1 id="3-proxysql的多层配置设计">3. proxysql的多层配置设计<a hidden class="anchor" aria-hidden="true" href="#3-proxysql的多层配置设计">#</a></h1>
<p>ProxySQL采用多层配置的设计来达到以下目的：</p>
<ul>
<li>允许在线应用配置项，而不需要重启proxysql</li>
<li>使用MySQL接口风格，来操作配置项，自定更新</li>
<li>如果配置有误，可以轻易回滚</li>
</ul>
<p><img alt="ProxySQL Multi layer configuration system" loading="lazy" src="http://github.com/seanlook/sean-notes-comment/raw/main/static/proxysql-config-multi-layer.png"></p>
<p><strong>RUNTIME</strong> 代表的是ProxySQL当前生效的配置，包括 global_variables, mysql_servers, mysql_users, mysql_query_rules。无法直接修改这里的配置，必须要从下一层load进来。
<strong>MEMORY</strong> 是平时在mysql命令行修改的 main 里头配置，可以认为是SQLite数据库在内存的镜像
<strong>DISK / CONFIG FILE</strong> 持久存储的那份配置，一般在<code>$(DATADIR)/proxysql.db</code>，在重启的时候会从硬盘里加载。 <code>/etc/proxysql.cnf</code>文件只在第一次初始化的时候用到，完了后，如果要修改监听端口，还是需要在管理命令行里修改，再 save 到硬盘。</p>
<p>需要修改配置时，直接操作的是 MEMORAY，以下命令可用于加载或保存 <code>users</code>： （序号对应上图）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[1]: LOAD MYSQL USERS TO RUNTIME / LOAD MYSQL USERS FROM MEMORY  -- 常用
</span></span><span class="line"><span class="cl">[2]: SAVE MYSQL USERS TO MEMORY / SAVE MYSQL USERS FROM RUNTIME
</span></span><span class="line"><span class="cl">[3]: LOAD MYSQL USERS TO MEMORY / LOAD MYSQL USERS FROM DISK
</span></span><span class="line"><span class="cl">[4]: SAVE MYSQL USERS TO DISK /  SAVE MYSQL USERS FROM MEMORY    -- 常用
</span></span><span class="line"><span class="cl">[5]: LOAD MYSQL USERS FROM CONFIG
</span></span></code></pre></td></tr></table>
</div>
</div><p>我比较习惯用 <code>TO</code>，记住往上层是 LOAD，往下层是 SAVE。</p>
<p>以下命令加载或保存<code>servers</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[1]: LOAD MYSQL SERVERS TO RUNTIME  -- 常用，让修改的配置生效
</span></span><span class="line"><span class="cl">[2]: SAVE MYSQL SERVERS TO MEMORY
</span></span><span class="line"><span class="cl">[3]: LOAD MYSQL SERVERS TO MEMORY
</span></span><span class="line"><span class="cl">[4]: SAVE MYSQL SERVERS TO DISK     -- 常用，将修改的配置持久化
</span></span><span class="line"><span class="cl">[5]: LOAD MYSQL SERVERS FROM CONFIG
</span></span></code></pre></td></tr></table>
</div>
</div><p>后面的使用方法也基本相同，一并列出。
以下命令加载或保存<code>query rules</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">mysql</span> <span class="n">query</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">run</span>    <span class="o">--</span> <span class="err">常用</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">save</span> <span class="n">mysql</span> <span class="n">query</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">mem</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">mysql</span> <span class="n">query</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">mem</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">save</span> <span class="n">mysql</span> <span class="n">query</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">disk</span>   <span class="o">--</span> <span class="err">常用</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">mysql</span> <span class="n">query</span> <span class="n">rules</span> <span class="n">from</span> <span class="n">config</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以下命令加载或保存 <code>mysql variables</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">runtime</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">save</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">save</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">disk</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">from</span> <span class="n">config</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以下命令加载或保存<code>admin variables</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">admin</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">runtime</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">save</span> <span class="n">admin</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">admin</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">memory</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">save</span> <span class="n">admin</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">disk</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nb">load</span> <span class="n">admin</span> <span class="n">variables</span> <span class="n">from</span> <span class="n">config</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下一篇文章将演示ProxySQL读写分离与分库的路由规则编写：http://xgknight.com/2017/04/17/mysql-proxysql-route-rw_split/</p>
<h1 id="参考">参考：<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h1>
<ul>
<li><a href="https://severalnines.com/blog/mysql-load-balancing-proxysql-overview">https://severalnines.com/blog/mysql-load-balancing-proxysql-overview</a></li>
<li><a href="https://github.com/sysown/proxysql/wiki">https://github.com/sysown/proxysql/wiki</a></li>
<li><a href="http://www.techietown.info/2017/01/mysql-readwrite-splitting-proxysql/">http://www.techietown.info/2017/01/mysql-readwrite-splitting-proxysql/</a></li>
</ul>
<hr>
<p>原文连接地址：http://xgknight.com/2017/04/10/mysql-proxysql-install-config/</p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/mysql/">Mysql</a></li>
      <li><a href="http://localhost:1313/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li>
      <li><a href="http://localhost:1313/tags/proxysql/">Proxysql</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/2017/04/mysql-proxysql-route-rw_split/">
    <span class="title">« Prev</span>
    <br>
    <span>ProxySQL之读写分离与分库路由演示</span>
  </a>
  <a class="next" href="http://localhost:1313/2017/04/qingming-2017/">
    <span class="title">Next »</span>
    <br>
    <span>清明闲扯</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
        repo="seanlook/sean-notes-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Sean&#39;s Note</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
