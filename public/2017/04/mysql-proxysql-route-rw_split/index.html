<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>ProxySQL之读写分离与分库路由演示 | Sean&#39;s Note</title>
<meta name="keywords" content="mysql, 中间件, proxysql">
<meta name="description" content="本文演示使用ProxySQL来完成读写分离和后端分库的一个实际配置过程，安装及配置项介绍见前文 ProxySQL之安装及配置详解。
环境


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11


instance0: 10.0.100.100 (db0,db2,db4,db6)
instance1: 10.0.100.101 (db1,db3,db5,db7)
instance2: 10.0.100.102 (db2,db6,db10,db14)
instance3: 10.0.100.103 (db3,db7,db11,db15)

instance0 slave: 192.168.10.4:3316
instance1 slave: 192.168.10.4:3326
instance2 slave: 192.168.10.4:3336
instance3 slave: 192.168.10.4:3346

proxysql node0: 10.0.100.36


现在想达到这样一个目的：客户端应用连接上 proxysql 的ip:port，连接时指定分库db名，执行sql时自动路由到对应的实例、对应的库。考虑下面的部署结构：
">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/2017/04/mysql-proxysql-route-rw_split/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8a19d6c7d40c68078a482516c7c2a326ccb9f6e9282cabe7240ecc1a80c6cb47.css" integrity="sha256-ihnWx9QMaAeKSCUWx8KjJsy59ukoLKvnJA7MGoDGy0c=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/img/logo.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/img/logo.gif">
<link rel="apple-touch-icon" href="http://localhost:1313/logo.gif">
<link rel="mask-icon" href="http://localhost:1313/logo.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/2017/04/mysql-proxysql-route-rw_split/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Sean&#39;s Note (Alt + H)">Sean&#39;s Note</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      ProxySQL之读写分离与分库路由演示
    </h1>
    <div class="post-meta"><span title='2017-04-17 15:32:49 +0000 UTC'>2017-04-17</span>&nbsp;·&nbsp;8 min

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#1-%e9%85%8d%e7%bd%ae%e5%90%8e%e7%ab%afdb" aria-label="1. 配置后端DB">1. 配置后端DB</a></li>
                    <li>
                        <a href="#2-%e9%85%8d%e7%bd%ae%e7%94%a8%e6%88%b7" aria-label="2. 配置用户">2. 配置用户</a></li>
                    <li>
                        <a href="#3-%e4%bf%ae%e6%94%b9%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f" aria-label="3. 修改全局变量">3. 修改全局变量</a></li>
                    <li>
                        <a href="#4-%e6%b7%bb%e5%8a%a0%e8%b7%af%e7%94%b1%e8%a7%84%e5%88%99" aria-label="4. 添加路由规则">4. 添加路由规则</a></li>
                    <li>
                        <a href="#5-%e6%95%88%e6%9e%9c%e6%bc%94%e7%a4%ba" aria-label="5. 效果演示">5. 效果演示</a></li>
                    <li>
                        <a href="#6-%e5%8f%a6%e4%b8%80%e7%a7%8d%e8%a7%84%e5%88%99%e5%86%99%e6%b3%95" aria-label="6. 另一种规则写法">6. 另一种规则写法</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>


  <div class="post-content"><p>本文演示使用ProxySQL来完成读写分离和后端分库的一个实际配置过程，安装及配置项介绍见前文 <a href="http://xgknight.com/2017/04/10/mysql-proxysql-install-config/">ProxySQL之安装及配置详解</a>。</p>
<p>环境</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">instance0: 10.0.100.100 (db0,db2,db4,db6)
</span></span><span class="line"><span class="cl">instance1: 10.0.100.101 (db1,db3,db5,db7)
</span></span><span class="line"><span class="cl">instance2: 10.0.100.102 (db2,db6,db10,db14)
</span></span><span class="line"><span class="cl">instance3: 10.0.100.103 (db3,db7,db11,db15)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">instance0 slave: 192.168.10.4:3316
</span></span><span class="line"><span class="cl">instance1 slave: 192.168.10.4:3326
</span></span><span class="line"><span class="cl">instance2 slave: 192.168.10.4:3336
</span></span><span class="line"><span class="cl">instance3 slave: 192.168.10.4:3346
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">proxysql node0: 10.0.100.36
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在想达到这样一个目的：客户端应用连接上 proxysql 的ip:port，连接时指定分库db名，执行sql时自动路由到对应的实例、对应的库。考虑下面的部署结构：
<img alt="ProxySQL Deploy" loading="lazy" src="http://github.com/seanlook/sean-notes-comment/raw/main/static/proxysql-rw-lb-deploy.png"></p>
<p>任何一个proxysql节点都是对等的，路由请求到后端instance的各个database上。</p>
<h1 id="1-配置后端db">1. 配置后端DB<a hidden class="anchor" aria-hidden="true" href="#1-配置后端db">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- proxysql admin cli
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">insert into mysql_servers(hostgroup_id,hostname,port,weight,weight,comment) values
</span></span><span class="line"><span class="cl">  (100, &#39;10.0.100.100&#39;, 3307, 1, &#39;db0,ReadWrite&#39;),
</span></span><span class="line"><span class="cl">  (1000, &#39;10.0.100.100&#39;, 3307, 1, &#39;db0,ReadWrite&#39;),(1000, &#39;192.168.10.4&#39;, 3316, 9, &#39;db0,ReadOnly&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">insert into mysql_servers(hostgroup_id,hostname,port,weight,weight,comment) values
</span></span><span class="line"><span class="cl">  (101, &#39;10.0.100.101&#39;, 3307, 1, &#39;db1,ReadWrite&#39;),
</span></span><span class="line"><span class="cl">  (1001, &#39;10.0.100.101&#39;, 3307, 1, &#39;db1,ReadWrite&#39;),(1001, &#39;192.168.10.4&#39;, 3326, 9, &#39;db1,ReadOnly&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">insert into mysql_servers(hostgroup_id,hostname,port,weight,weight,comment) values
</span></span><span class="line"><span class="cl">  (102, &#39;10.0.100.102&#39;, 3307, 1, &#39;db2,ReadWrite&#39;),
</span></span><span class="line"><span class="cl">  (1002, &#39;10.0.100.102&#39;, 3307, 1, &#39;db2,ReadWrite&#39;),(1002, &#39;192.168.10.4&#39;, 3336, 9, &#39;db2,ReadOnly&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">insert into mysql_servers(hostgroup_id,hostname,port,weight,weight,comment) values
</span></span><span class="line"><span class="cl">  (103, &#39;10.0.100.103&#39;, 3307, 1, &#39;db3,ReadWrite&#39;),
</span></span><span class="line"><span class="cl">  (1003, &#39;10.0.100.103&#39;, 3307, 1, &#39;db3,ReadWrite&#39;),(1003, &#39;192.168.10.4&#39;, 3346, 9, &#39;db3,ReadOnly&#39;);
</span></span></code></pre></td></tr></table>
</div>
</div><p>比如 100 是主库，则 1000 是从库，同时主库也可以处理 1/10 的读请求。</p>
<h1 id="2-配置用户">2. 配置用户<a hidden class="anchor" aria-hidden="true" href="#2-配置用户">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- proxysql admin cli
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">insert into mysql_users(username, password,active,transaction_persistent)
</span></span><span class="line"><span class="cl">  values(&#39;user0&#39;, &#39;password0&#39;, 1, 1),(&#39;read1&#39;, &#39;password1&#39;, 1, 1);
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里将 transaction_persistent 设置为1，如果不知道它的含义，请参考前文。</p>
<p>要确保用户有能够登陆到后端的所有db的权限。</p>
<h1 id="3-修改全局变量">3. 修改全局变量<a hidden class="anchor" aria-hidden="true" href="#3-修改全局变量">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- proxysql admin cli
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">set mysql-default_charset=&#39;utf8mb4&#39;;
</span></span><span class="line"><span class="cl">set mysql-query_retries_on_failure=0;
</span></span><span class="line"><span class="cl">set mysql-max_stmts_per_connection=1000;
</span></span><span class="line"><span class="cl">set mysql-eventslog_filename=&#39;queries.log&#39;;
</span></span><span class="line"><span class="cl">set monitor_slave_lag_when_null=7200;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">set mysql-ping_timeout_server=1500;
</span></span><span class="line"><span class="cl">set mysql-monitor_connect_timeout=1000;
</span></span><span class="line"><span class="cl">set mysql-default_max_latency_ms=2000;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">set mysql-monitor_username=&#39;monitor&#39;;
</span></span><span class="line"><span class="cl">set mysql-monitor_password=&#39;monitor&#39;;
</span></span><span class="line"><span class="cl">set mysql-server_version=&#39;5.6.16&#39;;
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要提前给 monitor 账号开通权限，一般共用监控数据库的权限就足够了。</p>
<p><strong>让上面所有的修改生效</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">--</span> <span class="n">proxysql</span> <span class="n">admin</span> <span class="n">cli</span>
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="err">应用</span>
</span></span><span class="line"><span class="cl"><span class="nb">load</span> <span class="n">mysql</span> <span class="n">users</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">load</span> <span class="n">mysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">load</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">--</span> <span class="err">保存到磁盘</span>
</span></span><span class="line"><span class="cl"><span class="n">save</span> <span class="n">mysql</span> <span class="n">users</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">save</span> <span class="n">mysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">save</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">save</span> <span class="n">mysql</span> <span class="n">users</span> <span class="n">to</span> <span class="n">mem</span><span class="p">;</span>  <span class="o">--</span> <span class="err">可以屏蔽看到的明文密码</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="4-添加路由规则">4. 添加路由规则<a hidden class="anchor" aria-hidden="true" href="#4-添加路由规则">#</a></h1>
<p>一般配置ProxySQL规则步骤是 <a href="https://github.com/sysown/proxysql/issues/653#issuecomment-242122732">issues #653</a> :</p>
<ol>
<li>配置proxysql，将所有sql都发到主库</li>
<li>分析表 <code>stats_mysql_query_digest</code> 里面哪几种查询占比高</li>
<li>筛选哪些些占比高的SELECT，可以路由到从库</li>
<li>修改 <code>mysql_query_rules</code> 里面的规则，使其生效。不要一味的把所有查询都路由到主库</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- [1] read&amp;write split
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id, active,match_digest,apply,flagOUT) values(49, 1,&#39;^select\s.*\sfor update&#39;,0,21);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id, active,match_digest,apply,flagOUT) values(50, 1,&#39;^\(?select&#39;,0,20);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id, active,match_digest,negate_match_pattern,apply,flagOUT) values(60, 1,&#39;^select&#39;,1,0,21);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- 下面最好从rule_id 70开始，中间留空
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [2] flag 20 read
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(active,schemaname,destination_hostgroup,apply,flagIN,flagOUT) values
</span></span><span class="line"><span class="cl">  (1,&#39;db0&#39;,1000,1,20,20), (1,&#39;db1&#39;,1001,1,20,20), (1,&#39;db2&#39;,1002,1,20,20), (1,&#39;db3&#39;,1003,1,20,20), (1,&#39;db4&#39;,1000,1,20,20), (1,&#39;db5&#39;,1001,1,20,20), (1,&#39;db6&#39;,1002,1,20,20), (1,&#39;db7&#39;,1003,1,20,20),
</span></span><span class="line"><span class="cl">  (1,&#39;db8&#39;,1000,1,20,20), (1,&#39;db9&#39;,1001,1,20,20), (1,&#39;db10&#39;,1002,1,20,20), (1,&#39;db11&#39;,1003,1,20,20), (1,&#39;db12&#39;,1000,1,20,20), (1,&#39;db13&#39;,1001,1,20,20), (1,&#39;db14&#39;,1002,1,20,20), (1,&#39;db15&#39;,1003,1,20,20);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [3] flag 21 write
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(active,schemaname,destination_hostgroup,apply,flagIN,flagOUT) values
</span></span><span class="line"><span class="cl">  (1,&#39;db0&#39;,100,1,21,21), (1,&#39;db1&#39;,101,1,21,21), (1,&#39;db2&#39;,102,1,21,21), (1,&#39;db3&#39;,103,1,21,21), (1,&#39;db4&#39;,100,1,21,21), (1,&#39;db5&#39;,101,1,21,21), (1,&#39;db6&#39;,102,1,21,21), (1,&#39;db7&#39;,103,1,21,21), 
</span></span><span class="line"><span class="cl">  (1,&#39;db8&#39;,100,1,21,21), (1,&#39;db9&#39;,101,1,21,21), (1,&#39;db10&#39;,102,1,21,21), (1,&#39;db11&#39;,103,1,21,21), (1,&#39;db12&#39;,100,1,21,21), (1,&#39;db13&#39;,101,1,21,21), (1,&#39;db14&#39;,102,1,21,21), (1,&#39;db15&#39;,103,1,21,21);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [4] no schema given when connect
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,schemaname,apply,flagOUT) values(20,1,&#39;information_schema&#39;,0,302);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [5] route according to dbX.
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) values(1000,1,&#39;([\s\`])db(0|4|8|12)([\.\`])&#39;,100,1,302,302);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) values(1001,1,&#39;([\s\`])db(1|5|9|13)([\.\`])&#39;,101,1,302,302);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) values(1002,1,&#39;([\s\`])db(2|6|10|14)([\.\`])&#39;,102,1,302,302);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) values(1003,1,&#39;([\s\`])db(3|7|11|15)([\.\`])&#39;,103,1,302,302);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [6] wrong usage
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,apply,flagIN,flagOUT,error_msg,comment) 
</span></span><span class="line"><span class="cl">  values(1404,1,&#39;^SELECT DATABASE\(\)$&#39;,1,302,302,&#39;You should specify schema name first&#39;, &#39;use db0 Take long when no schema given for connection&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [7] default route
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,apply, flagIN,flagOUT,error_msg,comment) values(9999,1,1, 302,302,&#39;No query rules matched (by ProxySQL)&#39;, &#34;Don&#39;t define the default hostgroup 0 for ME&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [8]
</span></span><span class="line"><span class="cl">LOAD MYSQL QUERY RULES TO RUN;
</span></span><span class="line"><span class="cl">SAVE MYSQL QUERY RULES TO DISK;
</span></span></code></pre></td></tr></table>
</div>
</div><p>逐个解释：</p>
<ol>
<li>
<p>以 select 开头并且不是 for update 类型的SQL，进入到新的规则链flagOUT=20;<br>
其它诸如 insert, delete, update, replace, set, show 等语句，都进入到规则链flagOUT=21。
注：&rsquo;^(?select&rsquo; 规则匹配以<code>select</code>或 <code>(select</code> 开头的查询，但目前proxysql(1.3.6, 1.4.1)版本对以 <code>(</code> 开头的查询不记录 stats_mysql_query_digest 表。<a href="https://github.com/sysown/proxysql/issues/1100">#issue 1100</a></p>
<p>有个小技巧，mysql_query_rules 表的rule_id有自增，但最好从中间某个数开始，因为一旦后续可能需要紧急在前面插入规则，从1开始就没空位了。</p>
<p>这里大家可能有个顾虑，从库上可以执行 <code>set NAMES xxx</code>, <code>set session sql_mode=xxx</code>, <code>SET autocommit=?</code>, <code>commit</code>, <code>rollback</code>, <code>START TRANSACTION</code>, <code>use dbx</code> 这样的语句，不能全路由到主库吧？对此，另起了一篇文章 <a href="http://xgknight.com/2017/04/17/mysql-proxysql-multiplexing">http://xgknight.com/2017/04/17/mysql-proxysql-multiplexing</a> 。</p>
</li>
<li>
<p>flagIN=20 是 <em>只读链</em> 的入口<br>
根据连接时指定的dbname，路由到对应的分库上。db0, db4, db8, db12 路由到 hostgroup_id=1000 ，db1, db5, db9, db16 路由到 hostgroup_id=1002 ，依次类推。
flagIN=flagOUT 则结束匹配。</p>
</li>
<li>
<p>flagOUT=21 是 <em>读写链</em>的入口<br>
与上面的 [2] 类似，但是根据dbname路由到主库。</p>
</li>
<li>
<p>当建立连接的时候没有指定dbname时，分两种情况</p>
</li>
</ol>
<ul>
<li>使用连接的时候 <code>use db0</code>，因为mysql协议在每次 use dbname 时都会发送一个 <code>SELECT DATABASE()</code> 命令，第一次由于没有连接上后端任何DB，命令会执行超时失败，再次 use db0 是才成功。具体参考我所提的 <a href="https://github.com/sysown/proxysql/issues/988">issue #988</a> 。
因此这里我为它添加了一个规则 <strong>[6]</strong>，遇到这种情况马上处理，而不用等待失败。</li>
<li>使用连接时从未有默认schema，添加规则 <strong>[5]</strong>，使用 <code>schemaname.tablename</code> 的形式匹配 schemaname，然后路由到对应的 hostgroup 。</li>
</ul>
<ol start="7">
<li>因为没有定义 hostgroup 0，在意外情况什么规则都没匹配上时也依旧会等待失败，所以默认规则（默认路由）返回一个错误。</li>
</ol>
<h1 id="5-效果演示">5. 效果演示<a hidden class="anchor" aria-hidden="true" href="#5-效果演示">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">db0 与 db15 分别在两个实例上：
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; select * from db0.tbl_0;
</span></span><span class="line"><span class="cl">+-----+----------------+--------+
</span></span><span class="line"><span class="cl">| fid | username       | corpid |
</span></span><span class="line"><span class="cl">+-----+----------------+--------+
</span></span><span class="line"><span class="cl">|   1 | db0 aa         |      0 |
</span></span><span class="line"><span class="cl">|   2 | db0 aa         |     16 |
</span></span><span class="line"><span class="cl">|   3 | db0 autocommit |     32 |
</span></span><span class="line"><span class="cl">+-----+----------------+--------+
</span></span><span class="line"><span class="cl">3 rows in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; select * from db15.tbl_0;
</span></span><span class="line"><span class="cl">+-----+-----------------------------+--------+
</span></span><span class="line"><span class="cl">| fid | username                    | corpid |
</span></span><span class="line"><span class="cl">+-----+-----------------------------+--------+
</span></span><span class="line"><span class="cl">|   1 | db15 c2dfdf地方大幅度d      |     15 |
</span></span><span class="line"><span class="cl">|   2 | db15 c2dfdf地方大幅度d      |     47 |
</span></span><span class="line"><span class="cl">|   3 | db15 c2dfdf地方大幅度d      |    111 |
</span></span><span class="line"><span class="cl">+-----+-----------------------------+--------+
</span></span><span class="line"><span class="cl">3 rows in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">无法路由时，报错：
</span></span><span class="line"><span class="cl">(ecdba@10.0.100.36:6033) [(none)]&gt; show databases;
</span></span><span class="line"><span class="cl">ERROR 1148 (42000): No query rules matched (by ProxySQL)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">看到 rule 的命中数符合预期：
</span></span><span class="line"><span class="cl">-- proxysql admin cli
</span></span><span class="line"><span class="cl">(admin@127.0.0.1:6032) [(none)]&gt; select active,hits, mysql_query_rules.rule_id, schemaname, match_digest, match_pattern, replace_pattern,destination_hostgroup hostgroup,s.comment,flagIn,flagOUT   
</span></span><span class="line"><span class="cl">FROM mysql_query_rules NATURAL JOIN stats.stats_mysql_query_rules 
</span></span><span class="line"><span class="cl">JOIN mysql_servers s on destination_hostgroup=hostgroup_id ORDER BY mysql_query_rules.rule_id;
</span></span><span class="line"><span class="cl">+--------+------+---------+--------------------+--------------+-------------------------------+-----------------+-----------+--------+---------+
</span></span><span class="line"><span class="cl">| active | hits | rule_id | schemaname         | match_digest | match_pattern                 | replace_pattern | hostgroup | flagIN | flagOUT |
</span></span><span class="line"><span class="cl">+--------+------+---------+--------------------+--------------+-------------------------------+-----------------+-----------+--------+---------+
</span></span><span class="line"><span class="cl">| 1      | 3    | 20      | information_schema | NULL         | NULL                          | NULL            | NULL      | 0      | 302     |
</span></span><span class="line"><span class="cl">| 1      | 0    | 50      | NULL               | ^\(*select   | NULL                          | NULL            | NULL      | 0      | 20      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 60      | NULL               | ^select      | NULL                          | NULL            | NULL      | 0      | 21      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 61      | db0                | NULL         | NULL                          | NULL            | 1000      | 20     | 20      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 62      | db1                | NULL         | NULL                          | NULL            | 1001      | 20     | 20      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 63      | db2                | NULL         | NULL                          | NULL            | 1002      | 20     | 20      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 64      | db3                | NULL         | NULL                          | NULL            | 1003      | 20     | 20      |
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl">| 1      | 0    | 77      | db0                | NULL         | NULL                          | NULL            | 100       | 21     | 21      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 78      | db1                | NULL         | NULL                          | NULL            | 101       | 21     | 21      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 79      | db2                | NULL         | NULL                          | NULL            | 102       | 21     | 21      |
</span></span><span class="line"><span class="cl">| 1      | 0    | 80      | db3                | NULL         | NULL                          | NULL            | 103       | 21     | 21      |
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">| 1      | 0    | 92      | db15               | NULL         | NULL                          | NULL            | 103       | 21     | 21      |
</span></span><span class="line"><span class="cl">| 1      | 1    | 1000    | NULL               | NULL         | ([\s\`])db(0|4|8|12)([\.\`])  | NULL            | 100       | 302    | 302     |
</span></span><span class="line"><span class="cl">| 1      | 0    | 1001    | NULL               | NULL         | ([\s\`])db(1|5|9|13)([\.\`])  | NULL            | 101       | 302    | 302     |
</span></span><span class="line"><span class="cl">| 1      | 0    | 1002    | NULL               | NULL         | ([\s\`])db(2|6|10|14)([\.\`]) | NULL            | 102       | 302    | 302     |
</span></span><span class="line"><span class="cl">| 1      | 1    | 1003    | NULL               | NULL         | ([\s\`])db(3|7|11|15)([\.\`]) | NULL            | 103       | 302    | 302     |
</span></span><span class="line"><span class="cl">| 1      | 0    | 1404    | NULL               | NULL         | ^SELECT DATABASE\(\)$         | NULL            | NULL      | 302    | 302     |
</span></span><span class="line"><span class="cl">| 1      | 1    | 9999    | NULL               | NULL         | NULL                          | NULL            | NULL      | 302    | 302     |
</span></span><span class="line"><span class="cl">+--------+------+---------+--------------------+--------------+-------------------------------+-----------------+-----------+--------+---------+
</span></span><span class="line"><span class="cl">41 rows in set (0.01 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; select rule_id,schemaname,match_digest,match_pattern,destination_hostgroup,negate_match_pattern,apply,flagIN,flagOUT,error_msg from mysql_query_rules;
</span></span></code></pre></td></tr></table>
</div>
</div><p>切换数据库继续：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="p">(</span><span class="n">ecdba</span><span class="o">@</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span><span class="w"> </span><span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">db1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Database</span><span class="w"> </span><span class="nf">changed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">ecdba</span><span class="o">@</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">db1</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+-----+----------+--------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">fid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">corpid</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+-----+----------+--------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">db1</span><span class="w"> </span><span class="n">bb</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">   </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">db1</span><span class="w"> </span><span class="n">bb</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">   </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">db1</span><span class="w"> </span><span class="n">bb</span><span class="w">   </span><span class="o">|</span><span class="w">     </span><span class="mi">33</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+-----+----------+--------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">3</span><span class="w"> </span><span class="n">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">ecdba</span><span class="o">@</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">db1</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">db5</span><span class="o">`</span><span class="p">.</span><span class="n">tbl_0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+-----+--------------------+--------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">fid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">username</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">corpid</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+-----+--------------------+--------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">   </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">db5</span><span class="w"> </span><span class="n">ces测试</span><span class="w"> </span><span class="n">kfjd</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+-----+--------------------+--------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">db6并不在当前实例里</span><span class="err">：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">ecdba</span><span class="o">@</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">100</span><span class="p">.</span><span class="mi">36</span><span class="p">:</span><span class="mi">6033</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="n">db1</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">db6</span><span class="p">.</span><span class="n">tbl_0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">ERROR</span><span class="w"> </span><span class="mi">1146</span><span class="w"> </span><span class="p">(</span><span class="mi">42</span><span class="n">S02</span><span class="p">):</span><span class="w"> </span><span class="k">Table</span><span class="w"> </span><span class="s1">&#39;db6.tbl_0&#39;</span><span class="w"> </span><span class="n">doesn</span><span class="s1">&#39;t exist
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">现在show databases不会再报错：
</span></span></span><span class="line"><span class="cl"><span class="s1">(ecdba@10.0.100.36:6033) [db1]&gt; show databases;
</span></span></span><span class="line"><span class="cl"><span class="s1">+--------------------+
</span></span></span><span class="line"><span class="cl"><span class="s1">| Database           |
</span></span></span><span class="line"><span class="cl"><span class="s1">+--------------------+
</span></span></span><span class="line"><span class="cl"><span class="s1">| information_schema |
</span></span></span><span class="line"><span class="cl"><span class="s1">| db1                |
</span></span></span><span class="line"><span class="cl"><span class="s1">| db13               |
</span></span></span><span class="line"><span class="cl"><span class="s1">| db5                |
</span></span></span><span class="line"><span class="cl"><span class="s1">| db9                |
</span></span></span><span class="line"><span class="cl"><span class="s1">| mysql              |
</span></span></span><span class="line"><span class="cl"><span class="s1">| performance_schema |
</span></span></span><span class="line"><span class="cl"><span class="s1">+--------------------+
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">看到 stats 模块的统计信息：
</span></span></span><span class="line"><span class="cl"><span class="s1">-- proxysql admin cli
</span></span></span><span class="line"><span class="cl"><span class="s1">(admin@127.0.0.1:6032) [(none)]&gt; select hostgroup,schemaname,username,digest,substr(digest_text,120,-120),count_star from stats_mysql_query_digest;
</span></span></span><span class="line"><span class="cl"><span class="s1">+-----------+--------------------+----------+--------------------+--------------------------------------------+------------+
</span></span></span><span class="line"><span class="cl"><span class="s1">| hostgroup | schemaname         | username | digest             | substr(digest_text,120,-120)               | count_star |
</span></span></span><span class="line"><span class="cl"><span class="s1">+-----------+--------------------+----------+--------------------+--------------------------------------------+------------+
</span></span></span><span class="line"><span class="cl"><span class="s1">| 1002      | db2                | ecdba    | 0x45033ED34D21EDF5 | select * from tbl_0                        | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 102       | db2                | ecdba    | 0x02033E45904D3DF0 | show databases                             | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 102       | db2                | ecdba    | 0x99531AEFF718C501 | show tables                                | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 1001      | db1                | ecdba    | 0x620B328FE9D6D71A | SELECT DATABASE()                          | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 1001      | db1                | ecdba    | 0x903E7B5A87B51352 | select * from db6.tbl_0                    | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 1001      | db1                | ecdba    | 0x0CE250A1C0E2C539 | select * from `db5`.tbl_0                  | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 1001      | db1                | ecdba    | 0x45033ED34D21EDF5 | select * from tbl_0                        | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 101       | db1                | ecdba    | 0x02033E45904D3DF0 | show databases                             | 2          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 102       | db2                | ecdba    | 0x6F8289B2913564A0 | update tbl_0 set username=? where corpid=? | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 0         | information_schema | ecdba    | 0x620B328FE9D6D71A | SELECT DATABASE()                          | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 101       | db1                | ecdba    | 0x99531AEFF718C501 | show tables                                | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 0         | information_schema | ecdba    | 0x02033E45904D3DF0 | show databases                             | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 1001      | db1                | ecdba    | 0x7A3428659E1BFDC2 | select * from db5.tbl_0                    | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 103       | information_schema | ecdba    | 0xA951EB38FA9ED6A4 | select * from db15.tbl_0                   | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 100       | information_schema | ecdba    | 0xA132AEDEC5932600 | select * from db0.tbl_0                    | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 0         | information_schema | ecdba    | 0x594F2C744B698066 | select USER()                              | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">| 0         | information_schema | ecdba    | 0x226CD90D52A2BA0B | select @@version_comment limit ?           | 1          |
</span></span></span><span class="line"><span class="cl"><span class="s1">+-----------+--------------------+----------+--------------------+--------------------------------------------+------------+
</span></span></span><span class="line"><span class="cl"><span class="s1">17 rows in set (0.01 sec)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>达到了读写分离和分实例分库的目的。</p>
<h1 id="6-另一种规则写法">6. 另一种规则写法<a hidden class="anchor" aria-hidden="true" href="#6-另一种规则写法">#</a></h1>
<p>从上面可以看到，客户端应用在使用的时候，最好都要指定 database name ，上面是因为加了第 5 类规则才避免由于不指定db时所带来的问题，但始终要求对每个 分db 建立自己连接，或者查询之前 use dbname ，当然也可以在获取连接的时候，传递dbname过去，拿到带正确db的连接过来。</p>
<p>那么其实还有一种办法，不需要指定连接db，而是采用注释 hint 的形式，传递给proxysql，然后来自动路由。将第 4 节的规则 [2],[3] 改成下面的形式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-- [1] read&amp;write split
</span></span><span class="line"><span class="cl">-- instance0，read &amp; write
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (rule_id,active,match_pattern,apply,flagIN,flagOUT) VALUES (40,1,&#34;\/\*\s*shard_corp_mod=(0|4|8|12)\s*\*.&#34;,0,0,20);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (rule_id,active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) VALUES (50,1,&#39;^select&#39;,1000,1,20,20);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (active,match_digest,negate_match_pattern,destination_hostgroup,apply,flagIN,flagOUT) VALUES (1,&#34;^select&#34;,1,100,1,20,20);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (rule_id,active,match_pattern,apply,flagIN,flagOUT) VALUES (60,1,&#34;\/\*\s*shard_corp_mod=(1|5|9|13)\s*\*.&#34;,0,0,21);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) VALUES (1,&#39;^select&#39;,1001,1,21,21);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (active,match_digest,negate_match_pattern,destination_hostgroup,apply,flagIN,flagOUT) VALUES (1,&#34;^select&#34;,1,101,1,21,21);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (rule_id,active,match_pattern,apply,flagIN,flagOUT) VALUES (70,1,&#34;\/\*\s*shard_corp_mod=(2|6|10|14)\s*\*.&#34;,0,0,22);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) VALUES (1,&#39;^select&#39;,1002,1,22,22);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (active,match_digest,negate_match_pattern,destination_hostgroup,apply,flagIN,flagOUT) VALUES (1,&#34;^select&#34;,1,102,1,22,22);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (rule_id,active,match_pattern,apply,flagIN,flagOUT) VALUES (80,1,&#34;\/\*\s*shard_corp_mod=(3|7|11|15)\s*\*.&#34;,0,0,23);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (active,match_digest,destination_hostgroup,apply,flagIN,flagOUT) VALUES (1,&#39;^select&#39;,1003,1,23,23);
</span></span><span class="line"><span class="cl">INSERT INTO mysql_query_rules (active,match_digest,negate_match_pattern,destination_hostgroup,apply,flagIN,flagOUT) VALUES (1,&#34;^select&#34;,1,103,1,23,23);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [2] no /* shard_corp_mod=? */ given
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN) values(1000,1,&#39;([\s\`])db(0|4|8|12)([\.\`])&#39;,100,1,0);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN) values(1001,1,&#39;([\s\`])db(1|5|9|13)([\.\`])&#39;,101,1,0);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN) values(1002,1,&#39;([\s\`])db(2|6|10|14)([\.\`])&#39;,102,1,0);
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply,flagIN) values(1003,1,&#39;([\s\`])db(3|7|11|15)([\.\`])&#39;,103,1,0);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [3] wrong usage
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,schemaname,match_digest,apply,flagIN,error_msg,comment) 
</span></span><span class="line"><span class="cl">  values(1404,1,&#39;information_schema&#39;,&#39;^SELECT DATABASE\(\)$&#39;,1,0,&#39;You should specify schema name first&#39;, &#39;use db0 Take long when no schema given for connection&#39;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [7] default route
</span></span><span class="line"><span class="cl">insert into mysql_query_rules(rule_id,active,apply, flagIN,error_msg,comment) values(9999,1,1, 0,&#39;No query rules matched (by ProxySQL)&#39;, &#34;Don&#39;t define the default hostgroup 0 for ME&#34;);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- [8]
</span></span><span class="line"><span class="cl">LOAD MYSQL QUERY RULES TO RUN;
</span></span><span class="line"><span class="cl">SAVE MYSQL QUERY RULES TO DISK;
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意这里[2][3]用的是 <code>match_pattern</code>，而上节用的是<code>match_digest</code>，因为proxysql在处理fingerprint的时候，会去掉注释。如果在命令行测试，要加 <code>-c</code> 避免 HINT 被过滤掉。</p>
<p>使用时Hint放sql最后面，每个sql都要带mod或者指定实例：<code>select * from db5.tbl_0 /* shard_corp_mod=5 */</code>，真正实施起来，应用端的复杂度以及proxysql的性能，还是有待考虑的。</p>
<p>关于这些路由规则的写法对ProxySQL性能的影响，欢迎继续阅读这边文章 <a href="http://xgknight.com/2017/04/20/mysql-proxysql-performance-test/">ProxySQL之性能测试对比</a></p>
<p>参考：</p>
<ul>
<li><a href="https://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup">https://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup</a></li>
<li><a href="https://www.percona.com/blog/2016/08/30/mysql-sharding-with-proxysql/">https://www.percona.com/blog/2016/08/30/mysql-sharding-with-proxysql/</a></li>
</ul>
<hr>
<p>原文连接地址：http://xgknight.com/2017/04/17/mysql-proxysql-route-rw_split/</p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/mysql/">Mysql</a></li>
      <li><a href="http://localhost:1313/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li>
      <li><a href="http://localhost:1313/tags/proxysql/">Proxysql</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/2017/04/mysql-proxysql-multiplexing/">
    <span class="title">« Prev</span>
    <br>
    <span>ProxySQL之连接复用（multiplexing）以及相关问题说明</span>
  </a>
  <a class="next" href="http://localhost:1313/2017/04/mysql-proxysql-install-config/">
    <span class="title">Next »</span>
    <br>
    <span>ProxySQL之安装及配置详解</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
        repo="seanlook/sean-notes-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Sean&#39;s Note</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
